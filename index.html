<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sicoob 2026 | Gest√£o de Metas</title>
    <style>
        :root { 
            --azul: #003641; 
            --verde: #cbd300; 
            --cinza: #f4f7f8; 
            --branco: #ffffff;
            --vermelho: #dc3545;
            --success: #28a745;
            --roxo: #6f42c1;
            --dark-bg: #0d2b33; 
        }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--cinza); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1400px; margin: auto; background: var(--branco); border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); position: relative; min-height: 80vh; display: flex; flex-direction: column; }
        
        /* Cabe√ßalho */
        .header { background: var(--azul); color: white; padding: 20px; border-bottom: 6px solid var(--verde); display: flex; justify-content: space-between; align-items: center; border-radius: 10px 10px 0 0; }
        .header-sub { display: flex; gap: 20px; align-items: center; margin-top: 5px; flex-wrap: wrap; }
        .info-display { font-size: 0.9rem; color: var(--verde); font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Navega√ß√£o */
        .nav-tabs { display: flex; background: #e9ecef; padding: 10px 20px 0 20px; border-bottom: 1px solid #ddd; gap: 5px; }
        .nav-btn { padding: 12px 25px; border: none; background: #d1d9e0; color: var(--azul); font-weight: bold; cursor: pointer; border-radius: 8px 8px 0 0; font-size: 0.95rem; transition: 0.2s; }
        .nav-btn.active { background: white; color: var(--azul); border-top: 4px solid var(--verde); padding-top: 8px; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }

        /* Views */
        .view-section { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Controles */
        .controls-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #fdfdfd; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .select-custom { padding: 8px 15px; font-weight: bold; border-radius: 5px; border: 1px solid #ccc; color: var(--azul); cursor: pointer; background: white; }

        /* Tabela */
        .table-container { overflow-x: auto; border-radius: 6px; border: 1px solid #eee; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: var(--azul); color: white; padding: 12px; font-size: 0.8rem; text-transform: uppercase; border-right: 1px solid rgba(255,255,255,0.1); white-space: nowrap; }
        td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; font-size: 0.85rem; color: #444; }
        
        /* Destaque da Coluna Meta Anual */
        .col-meta-anual { background-color: #eef; font-weight: 800; color: var(--azul); border-left: 1px solid #ccc; border-right: 1px solid #ccc; }

        .col-nome { text-align: left !important; background-color: #f7fcfd; font-weight: 700; color: var(--azul); font-size: 0.85rem; border-left: 8px solid var(--verde); padding-left: 10px !important; width: 180px; position: sticky; left: 0; box-shadow: 2px 0 5px rgba(0,0,0,0.05); z-index: 10; }
        
        input.val-input { width: 70px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; }
        input.val-input:focus { border-color: var(--azul); background: #e0f7fa; outline: none; }
        .bar-bg { background: #eee; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 4px; border: 1px solid #e0e0e0; width: 100%; }
        .bar-fill { height: 100%; width: 0%; transition: 0.3s; background: #dc3545; }

        /* RESUMO ANUAL (Fundo Escuro) */
        .anual-box { background: var(--dark-bg); color: white; padding: 20px; margin: 0 20px 20px 20px; border-radius: 10px; }
        .anual-title { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; }
        .anual-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; }
        .anual-item { background: rgba(255,255,255,0.05); padding: 15px 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.1); transition: 0.3s; }
        .anual-item:hover { background: rgba(255,255,255,0.1); }
        .anual-item h4 { margin: 0 0 8px 0; font-size: 0.75rem; font-weight: normal; color: #ccc; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; min-height: 25px; display: flex; align-items: center; justify-content: center; }
        .anual-meta-label { font-size: 0.6rem; color: var(--verde); text-transform: uppercase; display: block; margin-bottom: 2px; }
        .anual-valor { font-size: 0.85rem; font-weight: bold; color: white; margin-bottom: 5px; display: block; }
        .anual-perc { font-size: 1.5rem; color: var(--verde); display: block; font-weight: 900; }

        /* Bot√µes */
        .footer-btns { text-align: center; margin-top: auto; display: flex; gap: 10px; justify-content: center; align-items: center; background: #e9ecef; padding: 20px; border-radius: 0 0 10px 10px; }
        .btn-acao { padding: 10px 20px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; font-size: 0.9rem; transition: 0.3s; display: flex; align-items: center; gap: 6px; }
        .btn-save { background: var(--roxo); color: white; }
        .btn-plan { background: #ff9800; color: white; }
        .btn-print { background: var(--azul); color: white; }
        .btn-limpar { background: #fff; color: #555; border: 1px solid #ccc; }
        .btn-admin { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; }

        /* Modais */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,54,65, 0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 800px; max-width: 95%; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .plan-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; overflow-y: auto; padding: 10px; background: #f9f9f9; border: 1px solid #eee; border-radius: 6px; }
        .plan-month-item { background: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }

        /* Impress√£o */
        @media print {
            @page { size: landscape; margin: 5mm; }
            body { background: white; -webkit-print-color-adjust: exact; transform: scale(0.95); }
            .no-print, .nav-tabs, .footer-btns, .btn-admin { display: none !important; }
            .container { box-shadow: none; max-width: 100%; width: 100%; border: none; }
            .anual-box { page-break-inside: avoid; margin: 10px 0; background: var(--dark-bg) !important; color: white !important; }
            .view-section { display: none; }
            .view-section.active { display: block; }
            table { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="header-title">
            <h1 style="margin:0">SICOOB <span style="font-weight:300">| SISTEMA DE METAS 2026</span></h1>
            <div class="header-sub">
                <div id="displayGerente" class="info-display">Gerente: ...</div>
                <div class="separador">|</div>
                <div id="displaySegmento" class="info-display">Segmento: ...</div>
            </div>
        </div>
        <div class="no-print">
            <button onclick="abrirPlanejamento()" class="btn-acao btn-plan" title="O Gerente distribui a Meta Anual definida">üìÖ Planejar Sazonalidade</button>
        </div>
    </div>

    <div class="nav-tabs no-print">
        <button class="nav-btn active" onclick="mudarAba('mensal')">üìù Lan√ßamento Mensal</button>
        <button class="nav-btn" onclick="mudarAba('semestral')">üóìÔ∏è Vis√£o Semestral</button>
        <button class="nav-btn" onclick="mudarAba('anual')">üìä Detalhamento Anual</button>
    </div>

    <div id="tituloImpresso" style="display:none; text-align:center; color:#003641; font-weight:bold; font-size:1.5rem; margin:10px 0;">RELAT√ìRIO DE DESEMPENHO</div>

    <div id="view-mensal" class="view-section active">
        <div class="controls-bar">
            <strong>M√™s de Refer√™ncia:</strong>
            <select id="mesSelect" class="select-custom" onchange="carregarDadosMensal()">
                <option value="JAN">JANEIRO</option><option value="FEV">FEVEREIRO</option>
                <option value="MAR">MAR√áO</option><option value="ABR">ABRIL</option>
                <option value="MAI">MAIO</option><option value="JUN">JUNHO</option>
                <option value="JUL">JULHO</option><option value="AGO">AGOSTO</option>
                <option value="SET">SETEMBRO</option><option value="OUT">OUTUBRO</option>
                <option value="NOV">NOVEMBRO</option><option value="DEZ">DEZEMBRO</option>
            </select>
        </div>
        <div class="table-container">
            <table id="tabelaMensal">
                <thead>
                    <tr>
                        <th class="col-nome">Produto</th>
                        <th>Meta do M√™s</th>
                        <th>Sem 1</th><th>Sem 2</th><th>Sem 3</th><th>Sem 4</th>
                        <th width="100">Total</th>
                        <th width="120">Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="view-semestral" class="view-section">
        <div class="controls-bar">
            <strong>Semestre:</strong>
            <select id="semestreSelect" class="select-custom" onchange="renderizarSemestral()">
                <option value="1">1¬∫ Semestre (Jan - Jun)</option>
                <option value="2">2¬∫ Semestre (Jul - Dez)</option>
            </select>
        </div>
        <div class="table-container">
            <table id="tabelaSemestral">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="view-anual" class="view-section">
        <h3 style="color:var(--azul); border-bottom:2px solid var(--verde); padding-bottom:5px;">Detalhamento Anual</h3>
        <div class="table-container">
            <table id="tabelaAnual">
                <thead>
                    <tr>
                        <th class="col-nome">Produto</th>
                        <th class="col-meta-anual">META ANUAL<br><small style="font-weight:normal; font-size:0.6rem">(Definida pelo Gestor)</small></th>
                        <th>Jan</th><th>Fev</th><th>Mar</th><th>Abr</th><th>Mai</th><th>Jun</th>
                        <th>Jul</th><th>Ago</th><th>Set</th><th>Out</th><th>Nov</th><th>Dez</th>
                        <th>Realizado</th>
                        <th>%</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="anual-box">
        <div class="anual-title">
            <span style="font-size:1.5rem">üìä</span>
            <h3 style="margin:0; font-weight:normal;">RESUMO ANUAL (ACUMULADO REAL)</h3>
            <span style="margin-left:auto; font-size:0.8rem; opacity:0.8">* Atualizado automaticamente</span>
        </div>
        <div class="anual-grid" id="gridAnualCards"></div>
    </div>

    <div class="footer-btns no-print">
        <button onclick="salvarArquivo()" class="btn-acao btn-save">üíæ Salvar Backup</button>
        <button onclick="window.print()" class="btn-acao btn-print">üñ®Ô∏è Imprimir</button>
        <button onclick="limparMesAtual()" class="btn-acao btn-limpar">üóëÔ∏è Limpar M√™s</button>
        <button onclick="abrirAdmin()" class="btn-admin">‚öôÔ∏è</button>
    </div>
</div>

<div id="modalPlan" class="modal-overlay">
    <div class="modal-content">
        <h3 style="color:var(--azul); border-bottom:2px solid var(--verde); padding-bottom:10px; margin-top:0">üìÖ Planejamento do Gerente</h3>
        <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">O Gestor definiu a <strong>Meta Anual</strong> abaixo. Distribua este valor entre os meses conforme sua estrat√©gia.</p>
        
        <div style="margin-bottom:15px; display:flex; gap:10px; align-items:center;">
            <label style="font-weight:bold;">Produto:</label>
            <select id="plan-produto-select" class="select-custom" style="flex:1" onchange="carregarPlanejamentoProduto()"></select>
        </div>

        <div style="display:flex; justify-content:space-between; margin-bottom:10px; background:#eef; padding:10px; border-radius:5px; border:1px solid #ccd;">
            <div>Meta Anual (Fixa): <strong id="plan-meta-total" style="color:var(--azul); font-size:1.1rem">0</strong></div>
            <div>Soma Distribu√≠da: <strong id="plan-soma-dist" style="color:#666">0</strong></div>
            <div>Restante: <strong id="plan-dif" style="color:red">0</strong></div>
        </div>

        <div id="container-inputs-meses" class="plan-grid"></div>

        <div style="margin-top:auto; padding-top:15px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:10px;">
            <button onclick="fecharModal('modalPlan')" class="btn-acao btn-limpar">Cancelar</button>
            <button onclick="aplicarDistribuicaoUniforme()" class="btn-acao" style="background:#17a2b8; color:white;">Dividir Igualmente (/12)</button>
            <button onclick="salvarPlanejamento()" class="btn-acao btn-save">Salvar Planejamento</button>
        </div>
    </div>
</div>

<div id="modalAdmin" class="modal-overlay">
    <div class="modal-content">
        <h3>üîß Configura√ß√£o (Apenas Gestor)</h3>
        <p style="font-size:0.8rem; color:gray">Aqui voc√™ define a META TOTAL DO ANO. O Gerente far√° a distribui√ß√£o mensal.</p>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
            <input type="text" id="adm-nome" placeholder="Nome Gerente" style="padding:8px; border:1px solid #ccc;">
            <select id="adm-seg" style="padding:8px; border:1px solid #ccc;"><option>PF</option><option>PJ</option><option>Agro</option></select>
        </div>
        <div style="display:grid; grid-template-columns: 2fr 0.8fr 1fr 30px; gap:10px; font-weight:bold; font-size:0.75rem; color:#888; margin-bottom:5px;">
            <span>NOME DO ITEM</span><span>TIPO</span><span>META ANUAL (TOTAL)</span><span></span>
        </div>
        <div id="listaItensAdmin" style="flex:1; overflow-y:auto; border:1px solid #eee; padding:5px; margin-bottom:10px;"></div>
        <button onclick="addAdmItem()" style="width:100%; padding:8px; background:#eaffea; border:1px dashed green;">+ Adicionar Produto</button>
        <div style="margin-top:15px; display:flex; justify-content:flex-end; gap:10px;">
            <button onclick="fecharModal('modalAdmin')" class="btn-acao btn-limpar">Cancelar</button>
            <button onclick="salvarAdmin()" class="btn-acao btn-save">Salvar Configura√ß√µes</button>
        </div>
    </div>
</div>

<script>
    /* DADOS E CONFIGURA√á√ÉO 
       Agora 'm' representa a META ANUAL CHEIA.
    */
    const DADOS_EMBUTIDOS = null;
    const MESES = ["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
    
    // Valores exatos da imagem do usu√°rio (Metas Anuais)
    const PADRAO = [
        { n: "Associados", m: 144, tipo: "int" },
        { n: "C√¢mbio (mil USD)", m: 24000, tipo: "usd" },
        { n: "Cobran√ßa", m: 48, tipo: "int" },
        { n: "Cons√≥rcio", m: 1080000, tipo: "brl" },
        { n: "Coopcerto", m: 12, tipo: "int" },
        { n: "Cr√©dito PJ", m: 11400000, tipo: "brl" },
        { n: "Fundos", m: 8400, tipo: "brl" },
        { n: "Matriz", m: 96, tipo: "int" },
        { n: "Capital Social", m: 492000, tipo: "brl" },
        { n: "Renda Fixa", m: 2520000, tipo: "brl" },
        { n: "Seguros Gerais", m: 72000, tipo: "brl" },
        { n: "Seguro Vida", m: 2400, tipo: "brl" },
        { n: "SicoobCard", m: 72, tipo: "int" },
        { n: "SIPAG", m: 120, tipo: "int" }
    ];

    let config = [];
    let planejamento = {}; 

    window.onload = function() {
        if(DADOS_EMBUTIDOS) {
            try { Object.keys(DADOS_EMBUTIDOS).forEach(k => localStorage.setItem(k, DADOS_EMBUTIDOS[k])); } catch(e){}
        }
        carregarConfig();
        mudarAba('mensal');
    };

    function carregarConfig() {
        // Mudamos a chave para V6 para garantir a nova estrutura de dados (Anual)
        config = JSON.parse(localStorage.getItem('SIC_CONFIG_FINAL_V6')) || JSON.parse(JSON.stringify(PADRAO));
        planejamento = JSON.parse(localStorage.getItem('SIC_PLAN_V6')) || {};
        
        document.getElementById('displayGerente').innerText = "Gerente: " + (localStorage.getItem('SIC_NOME') || "...");
        document.getElementById('displaySegmento').innerText = "Segmento: " + (localStorage.getItem('SIC_SEG') || "...");
        
        atualizarGridResumoAnual();
    }

    // Retorna a meta do m√™s: Ou √© planejada, ou √© Anual/12
    function getMetaDoMes(itemIdx, mesIdx) {
        if (planejamento[itemIdx] && planejamento[itemIdx].length === 12) {
            return parseFloat(planejamento[itemIdx][mesIdx]) || 0;
        }
        return config[itemIdx].m / 12; // Padr√£o se n√£o planejado
    }

    function fmt(v, tipo) {
        let opts = { maximumFractionDigits: 2, minimumFractionDigits: 2 };
        if(tipo === 'int') opts = { maximumFractionDigits: 0 };
        let s = v.toLocaleString('pt-BR', opts);
        return (tipo === 'brl' ? 'R$ '+s : (tipo === 'usd' ? 'U$ '+s : s));
    }
    function fmtS(v) { return v.toLocaleString('pt-BR', { maximumFractionDigits: 2 }); }

    /* RENDERIZA√á√ÉO */
    function mudarAba(view) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('view-'+view).classList.add('active');

        if(view === 'mensal') carregarDadosMensal();
        if(view === 'semestral') renderizarSemestral();
        if(view === 'anual') renderizarAnual();
        atualizarGridResumoAnual(); 
    }

    function carregarDadosMensal() {
        const mesCode = document.getElementById('mesSelect').value;
        const mesIdx = document.getElementById('mesSelect').selectedIndex;
        const tbody = document.querySelector('#tabelaMensal tbody');
        tbody.innerHTML = '';

        const saved = JSON.parse(localStorage.getItem('SIC_DADOS_FINAL_V6_' + mesCode)) || {};

        config.forEach((item, i) => {
            const vals = saved[i] || ["","","",""];
            const metaMes = getMetaDoMes(i, mesIdx); // Calcula a meta espec√≠fica deste m√™s
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="col-nome">${item.n}</td>
                <td class="col-meta">${fmt(metaMes, item.tipo)}</td>
                <td><input type="number" class="val-input" value="${vals[0]}" onchange="saveM('${mesCode}',${i},0,this.value)"></td>
                <td><input type="number" class="val-input" value="${vals[1]}" onchange="saveM('${mesCode}',${i},1,this.value)"></td>
                <td><input type="number" class="val-input" value="${vals[2]}" onchange="saveM('${mesCode}',${i},2,this.value)"></td>
                <td><input type="number" class="val-input" value="${vals[3]}" onchange="saveM('${mesCode}',${i},3,this.value)"></td>
                <td id="mt-${i}" style="font-weight:bold; color:var(--azul)">0</td>
                <td>
                    <div style="display:flex; align-items:center; gap:5px; justify-content:center">
                        <span id="mp-${i}" style="font-size:0.75rem; font-weight:bold">0%</span>
                        <div class="bar-bg" style="width:40px"><div id="mb-${i}" class="bar-fill"></div></div>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
            calcRow(i, vals, metaMes);
        });
    }

    function saveM(mes, item, sem, val) {
        let d = JSON.parse(localStorage.getItem('SIC_DADOS_FINAL_V6_' + mes)) || {};
        if(!d[item]) d[item] = ["","","",""];
        d[item][sem] = val;
        localStorage.setItem('SIC_DADOS_FINAL_V6_' + mes, JSON.stringify(d));
        
        let meta = getMetaDoMes(item, document.getElementById('mesSelect').selectedIndex);
        calcRow(item, d[item], meta);
        atualizarGridResumoAnual();
    }

    function calcRow(i, vals, meta) {
        let tot = vals.reduce((a,b)=>a+(parseFloat(b)||0),0);
        document.getElementById(`mt-${i}`).innerText = fmtS(tot);
        let p = meta > 0 ? Math.round((tot/meta)*100) : 0;
        document.getElementById(`mp-${i}`).innerText = p + "%";
        let bar = document.getElementById(`mb-${i}`);
        bar.style.width = Math.min(p, 100) + "%";
        bar.style.background = p >= 100 ? "var(--success)" : (p>=70 ? "#ffc107" : "var(--vermelho)");
    }

    /* VIEW ANUAL */
    function renderizarAnual() {
        const tb = document.querySelector('#tabelaAnual tbody');
        tb.innerHTML = "";
        config.forEach((item, i) => {
            let realAno = 0, cols = "";
            MESES.forEach(m => {
                let v = getRealMes(m, i);
                realAno += v;
                cols += `<td>${v>0?fmtS(v):'<small style="color:#eee">.</small>'}</td>`;
            });
            let p = item.m > 0 ? Math.round((realAno/item.m)*100) : 0;
            
            // Aqui a coluna Meta Anual exibe item.m diretamente (Valor do Gestor)
            tb.innerHTML += `
            <tr>
                <td class="col-nome">${item.n}</td>
                <td class="col-meta-anual">${fmt(item.m, item.tipo)}</td>
                ${cols}
                <td style="font-weight:bold">${fmtS(realAno)}</td>
                <td style="color:${p>=100?'green':'red'}; font-weight:bold">${p}%</td>
            </tr>`;
        });
    }

    function renderizarSemestral() {
        const sem = document.getElementById('semestreSelect').value;
        const indices = sem === "1" ? [0,1,2,3,4,5] : [6,7,8,9,10,11];
        let h = `<tr><th class="col-nome">Produto</th><th>Meta Sem.</th>`;
        indices.forEach(x => h+=`<th>${MESES[x]}</th>`);
        h+= `<th>Total</th><th>%</th></tr>`;
        document.querySelector('#tabelaSemestral thead').innerHTML = h;

        const tb = document.querySelector('#tabelaSemestral tbody');
        tb.innerHTML = "";
        
        config.forEach((item, i) => {
            let metaSem = 0, realSem = 0, cols = "";
            indices.forEach(mx => {
                metaSem += getMetaDoMes(i, mx); // Soma as metas mensais planejadas
                let rVal = getRealMes(MESES[mx], i);
                realSem += rVal;
                cols += `<td>${rVal>0?fmtS(rVal):'-'}</td>`;
            });
            let p = metaSem > 0 ? Math.round((realSem/metaSem)*100) : 0;
            tb.innerHTML += `<tr><td class="col-nome">${item.n}</td><td class="col-meta">${fmt(metaSem, item.tipo)}</td>${cols}<td style="font-weight:bold">${fmtS(realSem)}</td><td style="color:${p>=100?'green':'red'}">${p}%</td></tr>`;
        });
    }

    function getRealMes(mes, itemIdx) {
        let d = JSON.parse(localStorage.getItem('SIC_DADOS_FINAL_V6_' + mes)) || {};
        return (d[itemIdx] || []).reduce((a,b)=>a+(parseFloat(b)||0),0);
    }

    function atualizarGridResumoAnual() {
        const grid = document.getElementById('gridAnualCards');
        grid.innerHTML = "";
        config.forEach((item, i) => {
            let real = 0;
            MESES.forEach(m => real += getRealMes(m, i));
            let perc = item.m > 0 ? Math.round((real/item.m)*100) : 0;
            let cor = perc >= 100 ? "#4caf50" : (perc >= 70 ? "#ffeb3b" : "white"); 

            grid.innerHTML += `
                <div class="anual-item">
                    <h4>${item.n}</h4>
                    <span class="anual-meta-label">Meta Anual</span>
                    <span class="anual-valor">${fmt(real, item.tipo)} / ${fmt(item.m, item.tipo)}</span>
                    <strong class="anual-perc" style="color:${cor}">${perc}%</strong>
                </div>`;
        });
    }

    /* PLANEJAMENTO SAZONAL */
    function abrirPlanejamento() {
        document.getElementById('modalPlan').style.display = 'flex';
        const sel = document.getElementById('plan-produto-select');
        sel.innerHTML = "";
        config.forEach((item, i) => {
            let opt = document.createElement('option');
            opt.value = i;
            opt.text = item.n;
            sel.appendChild(opt);
        });
        carregarPlanejamentoProduto();
    }

    function carregarPlanejamentoProduto() {
        const idx = document.getElementById('plan-produto-select').value;
        const item = config[idx];
        const container = document.getElementById('container-inputs-meses');
        container.innerHTML = "";

        // Exibe a meta anual definida pelo Gestor
        document.getElementById('plan-meta-total').innerText = fmt(item.m, item.tipo);

        // Se j√° existe planejamento, carrega. Se n√£o, divide por 12
        let vals = planejamento[idx] || Array(12).fill(item.m / 12);

        MESES.forEach((m, k) => {
            container.innerHTML += `
                <div class="plan-month-item">
                    <label style="font-weight:bold; font-size:0.8rem; width:40px;">${m}</label>
                    <input type="number" id="pm-${k}" value="${parseFloat(vals[k]).toFixed(2)}" oninput="calcPlanTotal()" style="width:100px; padding:5px;">
                </div>`;
        });
        calcPlanTotal();
    }

    function calcPlanTotal() {
        let soma = 0;
        for(let k=0; k<12; k++) {
            soma += parseFloat(document.getElementById(`pm-${k}`).value) || 0;
        }
        const idx = document.getElementById('plan-produto-select').value;
        const meta = config[idx].m;
        const dif = meta - soma;

        document.getElementById('plan-soma-dist').innerText = fmtS(soma);
        
        const elDif = document.getElementById('plan-dif');
        elDif.innerText = fmtS(dif);
        // Margem de erro de arredondamento aceita (0.1)
        if(Math.abs(dif) < 0.1) { elDif.innerText = "OK"; elDif.style.color = "green"; }
        else { elDif.style.color = "red"; }
    }

    function aplicarDistribuicaoUniforme() {
        const idx = document.getElementById('plan-produto-select').value;
        const meta = config[idx].m;
        const valMensal = meta / 12;
        for(let k=0; k<12; k++) document.getElementById(`pm-${k}`).value = valMensal.toFixed(2);
        calcPlanTotal();
    }

    function salvarPlanejamento() {
        const idx = document.getElementById('plan-produto-select').value;
        let novosValores = [];
        for(let k=0; k<12; k++) novosValores.push(parseFloat(document.getElementById(`pm-${k}`).value) || 0);
        
        planejamento[idx] = novosValores;
        localStorage.setItem('SIC_PLAN_V6', JSON.stringify(planejamento));
        
        alert("Planejamento salvo! Metas mensais atualizadas.");
        carregarDadosMensal();
    }

    /* ADMIN - GESTOR */
    function fecharModal(id) { document.getElementById(id).style.display = 'none'; }
    
    function abrirAdmin() {
        if(prompt("Senha do Gestor:")!=="sicoob") return;
        document.getElementById('modalAdmin').style.display = 'flex';
        document.getElementById('adm-nome').value = localStorage.getItem('SIC_NOME')||"";
        document.getElementById('adm-seg').value = localStorage.getItem('SIC_SEG')||"PF";
        renderAdmList();
    }
    
    let configTemp = [];
    function renderAdmList() {
        configTemp = JSON.parse(JSON.stringify(config));
        const d = document.getElementById('listaItensAdmin');
        d.innerHTML = "";
        configTemp.forEach((item, i) => {
            // No Admin, mostra e edita a META ANUAL CHEIA
            d.innerHTML += `
            <div class="admin-row" style="display:grid; grid-template-columns: 2fr 0.8fr 1fr 30px; gap:10px; margin-bottom:5px; align-items:center;">
                <input value="${item.n}" onchange="configTemp[${i}].n=this.value">
                <select onchange="configTemp[${i}].tipo=this.value"><option value="int"${item.tipo=='int'?'selected':''}>123</option><option value="brl"${item.tipo=='brl'?'selected':''}>R$</option><option value="usd"${item.tipo=='usd'?'selected':''}>U$</option></select>
                <input value="${item.m}" type="number" onchange="configTemp[${i}].m=parseFloat(this.value)">
                <button onclick="delAdm(${i})" style="color:red; cursor:pointer; border:none; background:transparent">üóëÔ∏è</button>
            </div>`;
        });
    }
    function delAdm(i) { configTemp.splice(i,1); renderAdmList(); }
    function addAdmItem() { configTemp.push({n:"Novo", m:0, tipo:"int"}); renderAdmList(); }
    function salvarAdmin() {
        config = configTemp;
        localStorage.setItem('SIC_CONFIG_FINAL_V6', JSON.stringify(config));
        localStorage.setItem('SIC_NOME', document.getElementById('adm-nome').value);
        localStorage.setItem('SIC_SEG', document.getElementById('adm-seg').value);
        carregarConfig();
        fecharModal('modalAdmin');
        location.reload(); 
    }

    function salvarArquivo() {
        let dados = {};
        for(let i=0; i<localStorage.length; i++) {
            let k = localStorage.key(i);
            if(k.includes('SIC_')) dados[k] = localStorage.getItem(k);
        }
        let html = document.documentElement.outerHTML.replace('const DADOS_EMBUTIDOS = null;', `const DADOS_EMBUTIDOS = ${JSON.stringify(dados)};`);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([html], {type:'text/html'}));
        a.download = `SICOOB_METAS_V6.html`;
        a.click();
    }

    function limparMesAtual() {
        const mes = document.getElementById('mesSelect').value;
        if(confirm(`Limpar dados de ${mes}?`)) {
            localStorage.removeItem('SIC_DADOS_FINAL_V6_'+mes);
            carregarDadosMensal();
        }
    }
</script>
</body>
</html>